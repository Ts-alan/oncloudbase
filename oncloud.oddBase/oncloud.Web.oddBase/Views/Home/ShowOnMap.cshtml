@using oncloud.Domain.Entities
@{
    ViewBag.Title = "ShowOnMap";
}

<style>
    #fieldset {
    -webkit-box-shadow: 6px 4px 8px -2px rgba(0,0,0,0.75);
    -moz-box-shadow: 6px 4px 8px -2px rgba(0,0,0,0.75);
    box-shadow: 6px 4px 8px -2px rgba(0,0,0,0.75);
    padding: 10px;
}
</style>

<script src="~/Scripts/FullMapDisplay.js"></script>
<div class="row">
    <div class="col-md-12">
        <fieldset id="fieldset">
            <legend>Поиск</legend>
            <label for="city">Город</label>
            <input type="text" class="form-control" id="city"></>
            <label for="street">Улица</label>
            <input type="text" class="form-control" id="street" style="margin-bottom: 10px;"></>
            <button type="button" class="btn btn-default" onclick="findRoute()">Найти</button>
        </fieldset>
    </div>
</div>
<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div id="map" style="width: 900px; height: 600px; width: 100%; margin-top: 10px;" ></div>
    </div>
    </div>

@*Модальные окна*@
<div class="modal fade" id="layoutDislocation" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" style="border-width: 0px">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <div id="carousel-example-generic" class="carouselTCODD slide">
                    <!-- Indicators -->
                    <ol class="carousel-indicators" id="layoutDislocationIndicators"></ol>

                    <!-- Wrapper for slides -->
                    <div class="carousel-inner" role="listbox" id="TCODDcontainer">

                    </div>

                    <!-- Controls -->
                    <a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">
                        <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next">
                        <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
            </div>
            <div class="modal-footer" style="border-width: 0px">
                <button type="button" class="btn btn-default" onclick="printPicture('.TCODD')">Печать</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    ymaps.ready(init);
    var myMap;
    var balloon;
    var coordsArray = @Html.Raw(ViewBag.coordsJson);
    var idsArray = @Html.Raw(ViewBag.streestDislocationsListJSON);
    var myCollection = new ymaps.GeoObjectCollection();
    var newCollection = new ymaps.GeoObjectCollection();
    //console.log(idsArray);

    function init() {
        myMap = new ymaps.Map("map", {
            center: [53.9172, 27.5601],
            zoom: 11
        });
        //console.log(myMap.controls);
        myMap.behaviors.disable(["dblClickZoom"]);
        myMap.controls.remove('trafficControl').remove('mapTools').remove('searchControl').remove('ListBox');
        //console.log(myMap.controls.count);
        myMap.controls.add(
            new ymaps.control.TypeSelector(
                ['yandex#map', 'yandex#hybrid', 'yandex#satellite']
            )
        );
        var balloonContent = "";
        var itCount = 0;
        for (var i = 0; i < coordsArray.length; i++) {
            ymaps.route([[coordsArray[i].breadthS, coordsArray[i].lengthS], [coordsArray[i].breadthE, coordsArray[i].lengthE]]).then(function(route) {
                route.getPaths().options.set({
                    //можно выставить настройки графики маршруту
                    strokeColor: '0000ffff',
                    opacity: 0.9,
                    strokeWidth: 4
                });

                balloonContent = "<h4>" + coordsArray[itCount].name + "</h4><a type='button' href='#' IdSegment='" + itCount + "' onclick='setTCODD(this," + coordsArray[itCount].Id + ")' data-toggle='modal' data-target='#layoutDislocation' >Посмотреть дислокацию ТСОДД</a> <br>" +
                    "<a data-toggle='modal' href='/Home/Review/" + coordsArray[itCount].Id + "'>Посмотреть данные улицы</a>";

                //редактирование контента стандартного балуна
                route.getPaths().get(0).properties.set("balloonContentHeader", "");
                route.getPaths().get(0).properties.set("balloonContent", balloonContent);

                myCollection.add(route.getPaths(), i);
                itCount ++;
            }, function(error) {
                alert('Возникла ошибка: ' + error.message);
            });
        }
        
    }

    $(document).ready(function() {
        //слайдер опции
        $('.carouselTCODD').carousel({
            interval: false
        });

        //перелистование слайдера при нажатии на клавиши
        $("#layoutDislocation").on('keyup', function(e) {
            if (e.which == 39) {
                $("#carousel-example-generic .carousel-control.right").trigger('click');
            } else if (e.which == 37) {
                $("#carousel-example-generic .carousel-control.left").trigger('click');
            }
        });
    });

    function setTCODD(object, id) {
        //формирование выборки элементов с ид, равным ид выбранной улицы
        var result = $.grep(idsArray, function(idsArray) { return idsArray.streetId == id; });

        //заполнение модального окна
        $("#layoutDislocationIndicators").html(createModalList(result));
        $("#TCODDcontainer").html(createModalContent(result));


        $(".TCODD").each(function(indx, element) {
            $(element).removeClass("active");
        });

        $(".TCODD").eq(parseInt($(object).attr("idSegment"))).addClass("active");
    }

    function createModalList(result) {
        var content = "";
        for (var i = 0; i < result.length; i++) {
            content += '<li data-target="#carousel-example-generic" data-slide-to="' + i + '"></li>';
        }
        return content;
    }

    function createModalContent(result) {
        var list = "";

        list = '<div class="item TCODD"><h3 style="color: black; text-align: center">' +
                'г.Минск ул.' +
                result[0].streetName +
               '<br>Компоновочная схема</h3><img src="/Home/GetImageLayoutScheme/' + result[0].streetId + '"><div class="carousel-caption"></div></div>';
        for (var i = 0; i < result.length; i++) {
            list += '<div class="item TCODD"><h3 style="color: black; text-align: center">' +
                'г.Минск ул.' +
                result[0].streetName +
                '<br>Дислокация ТСОДД участок' +
                (i + 1) +
                '</h3>';
            if (idsArray[i].layoutdisId != null)
            {
                list += '<img id="TCODD" src="/Home/LayoutDislocation/' + result[i].layoutdisId + '"/>';
            }
            else
            {
                list += '<text><h3 style = "text-align: center" > Дислокация ТСОДД не загружена </h3></text>';
            }

            list += '<div class="carousel-caption"></div></div>';
        }

        return list;
    }

    function findRoute() {
        myMap.geoObjects = null;
        var tempCoordsArray;
        var city = $('#city').val();
        var street = $('#street').val();
        if (city!="" && street!="") {
            var cityFiltered = $.grep(coordsArray, function(coordsArray) { return coordsArray.cityName.toLowerCase().indexOf(city.toLowerCase()) > -1; });
            //console.log(cityFiltered);
            var streetFiltered = $.grep(cityFiltered, function(cityFiltered) { return cityFiltered.name.toLowerCase().indexOf(street.toLowerCase()) > -1; });
            //tempCoordsArray = coordsArray;
            //coordsArray = streetFiltered;
            //init();
            //coordsArray = tempCoordsArray;
        }
        if (city == "" && street != "") 
        {
            var streetOnlyFiltered = $.grep(coordsArray, function(coordsArray) { return coordsArray.name.toLowerCase().indexOf(street.toLowerCase()) > -1; });
            //tempCoordsArray = coordsArray;
            //coordsArray = streetOnlyFiltered;
            //init();
            //coordsArray = tempCoordsArray;
        } 
        else
        {
            var cityOnlyFiltered = $.grep(coordsArray, function(coordsArray) { return coordsArray.cityName.toLowerCase().indexOf(city.toLowerCase()) > -1; });
            //tempCoordsArray = coordsArray;
            //coordsArray = cityOnlyFiltered;
            //init();
            //coordsArray = tempCoordsArray;
        }
        
    }
    function addToGeoObjects(objCollection) 
    {
        myMap.geoObjects.add(objCollection);
    }

</script>
